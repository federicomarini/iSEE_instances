---
title: "Code for generating an instance of iSEE for the Human Cell Atlas datasets"
author:
- name: Federico Marini
  affiliation: 
  - &id1 Institute of Medical Biostatistics, Epidemiology and Informatics (IMBEI), Mainz
  - Center for Thrombosis and Hemostasis (CTH), Mainz
  email: marinif@uni-mainz.de
date: "`r BiocStyle::doc_date()`"
output: 
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

**Compiled date**: `r Sys.Date()`

**Last edited**: 2018-12-03

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  error = FALSE,
  warning = FALSE,
  message = FALSE
)
```


# Code for generating an instance of iSEE for the Human Cell Atlas datasets

```{r}
library(BiocStyle)
```

## Retrieving the data

The data can be retrieved from here: https://preview.data.humancellatlas.org

```{r eval=FALSE}
download.file("https://s3.amazonaws.com/preview-ica-expression-data/ica_cord_blood_h5.h5","ica_cord_blood_h5.h5")
download.file("https://s3.amazonaws.com/preview-ica-expression-data/ica_bone_marrow_h5.h5","ica_bone_marrow_h5.h5")

download.file("https://preview.data.humancellatlas.org/datasets/census/hca-metadata-census.xlsx","hca-metadata-census.xlsx")
```

Information is provided in the README file (https://s3.amazonaws.com/preview-ica-expression-data/Brief+ICA+Read+Me.pdf)

Some extra information might be extracted here: https://github.com/HumanCellAtlas/table-testing

## Retrieving the data - via `r BiocStyle::Biocpkg("HCAData")`

The `r Biocpkg("HCAData")` package allows a direct access to the dataset generated by the Human Cell Atlas project for further processing in R and Bioconductor.
It does so by providing the datasets as `r Biocpkg("SingleCellExperiment")` objects, i.e. a format which is both efficient and very widely adopted throughout many existing Bioconductor workflows.

The `r Biocpkg("HCAData")` package can be installed in the conventional way via `r CRANpkg("BiocManager")`.

```{r, eval=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install("HCAData")
```

This package makes extensive use of the `r Biocpkg("HDF5Array")` package to avoid loading the entire data set in memory.
Instead, it stores the counts on disk as a HDF5 file, and loads subsets of the data into memory upon request.

```{r}
library("HCAData")
HCAData()
```

The list of relevant files includes the HDF5 file containing the counts, as well as the metadata on the rows (genes) and columns (cells). 

The output is a single `SingleCellExperiment` object from the `r Biocpkg("SingleCellExperiment")` package. 

```{r}
# to access the bone marrow dataset, use
sce_bonemarrow <- HCAData("ica_bone_marrow")
sce_bonemarrow

# similarly, to access the umbilical cord blood dataset
sce_cordblood <- HCAData("ica_cord_blood")
sce_cordblood
```

## Packages setup

Here we are loading all packages one might need throughout this document

```{r}
library(AnnotationHub)
library(SingleCellExperiment)
library(scater)
library(scran)
library(iSEE)
library(rhdf5)
library(readxl)

```

## Reading in the available metadata

```{r}
hca_metadata_sheetnames <- readxl:::xlsx_sheets("hca-metadata-census.xlsx")

hca_metadata_list <- lapply(hca_metadata_sheetnames, function(arg) read_xlsx(path = "hca-metadata-census.xlsx",sheet = arg))
names(hca_metadata_list) <- hca_metadata_sheetnames
```


## Processing a subset of the HCA bone marrow data




## Saving the processed object

You can save the `sce` object to a serialized R object with 

```{r, eval=FALSE}
destination <- "where/to/store/the/processed/data.rds"
saveRDS(sce, file = destination)
```

The object can be read into a new R session with `readRDS(destination)`, provided the HDF5 file remains in its original location (conveniently stored in the default location of `ExperimentHub`).

## Session info {-}

```{r}
sessionInfo()
```


